<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarnerXd PRO - Admin Panel</title>
    <style>
        /* CSS styles remain the same for UI fidelity and expanded layout */
        :root {
            --primary-color: #009688; 
            --primary-light: #52c7b8;
            --secondary-color: #FF5252;
            --background-color: #e8eaf6;
            --surface-color: #ffffff;
            --on-primary: #ffffff;
            --on-surface: #1f1f1f;
            --shadow-elevation: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
        }
        body {
            font-family: 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .mobile-container {
            width: 100%;
            min-height: 100vh;
            max-width: 800px; /* NEW: Use a generous max-width for hosted/desktop admin view */
            margin: 0 auto;
            background-color: var(--surface-color);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.19), 0 6px 6px rgba(0, 0, 0, 0.23);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .hidden { display: none !important; }
        .page {
            flex-grow: 1;
            padding-top: 56px;
            padding-bottom: 24px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .material-card {
            background-color: var(--surface-color);
            border-radius: 8px;
            box-shadow: var(--shadow-elevation);
            padding: 16px;
            margin: 16px 0;
            transition: all 0.3s ease;
        }
        .material-btn {
            background-color: var(--primary-color);
            color: var(--on-primary);
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: 500;
            box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .material-btn:hover { background-color: #00796B; }
        .material-btn:active { box-shadow: none; }
        .danger-btn { background-color: var(--secondary-color); }
        .danger-btn:hover { background-color: #D32F2F; }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .list-item-controls {
            display: flex;
            gap: 8px;
        }
    </style>
    <!-- Material Icons CDN -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>

<div class="mobile-container">

    <!-- Admin Login Page -->
    <div class="auth-container" id="admin-auth-page">
        <h1>Admin Panel</h1>
        <p>Firebase Authentication Required</p>
        <input type="email" id="admin-email" placeholder="Admin Email" value="heml92304@gmail.com">
        <input type="password" id="admin-password" placeholder="Password" value="Admin12345">
        <button class="material-btn" onclick="window.handleAdminLogin()" style="width: 100%;">Login as Admin</button>
        <p id="admin-login-error" style="color: var(--secondary-color); margin-top: 10px;" class="hidden"></p>
    </div>

    <!-- Main Admin App Container (Hidden until logged in) -->
    <div id="admin-app" class="hidden" style="display: flex; flex-direction: column; flex-grow: 1; height: 100%;">

        <!-- Top Bar -->
        <header class="app-bar">
            <span id="back-btn" onclick="navigateTo('admin-dashboard-page')" class="hidden"><i class="material-icons">arrow_back</i></span>
            <h2 id="app-bar-title">Admin Dashboard</h2>
            <div class="app-bar-icons">
                <span onclick="handleAdminLogout()"><i class="material-icons">exit_to_app</i></span>
            </div>
        </header>

        <!-- Dynamic Page Content -->
        <div class="page-area" style="flex-grow: 1; overflow-y: auto;">
            
            <!-- ADMIN HOME DASHBOARD -->
            <div class="page page-content active-page" id="admin-dashboard-page" style="padding: 16px;">
                <h1 style="color: var(--primary-color); margin-top: 0;">System Overview</h1>
                <div class="dashboard-grid">
                    <div class="stat-box">
                        <i class="material-icons" style="font-size: 32px;">group</i>
                        <h3 id="total-users-count">0</h3>
                        <p>Total Users</p>
                    </div>
                    <div class="stat-box">
                        <i class="material-icons" style="font-size: 32px;">paid</i>
                        <h3 id="total-rewards-given">0</h3>
                        <p>Rewards Given (Approx)</p>
                    </div>
                    <div class="stat-box">
                        <i class="material-icons" style="font-size: 32px;">assignment</i>
                        <h3 id="total-tasks-added">0</h3>
                        <p>Tasks Added</p>
                    </div>
                    <div class="stat-box">
                        <i class="material-icons" style="font-size: 32px;">emoji_events</i>
                        <h3 id="total-tournaments-added">0</h3>
                        <p>Tournaments Added</p>
                    </div>
                </div>

                <h2 style="color: var(--primary-color); margin-top: 32px;">Admin Actions</h2>
                <div class="action-grid">
                    <div class="action-btn" data-page-target="task-management-page">
                        <i class="material-icons">task</i>
                        <span>Task Management</span>
                    </div>
                    <div class="action-btn" data-page-target="tournament-management-page">
                        <i class="material-icons">edit</i>
                        <span>Edit Tournaments</span>
                    </div>
                    <div class="action-btn" data-page-target="task-requests-page">
                        <i class="material-icons">check_circle</i>
                        <span>Task Requests</span>
                    </div>
                    
                    <div class="action-btn" data-page-target="withdrawal-requests-page">
                        <i class="material-icons">account_balance_wallet</i>
                        <span>Withdrawals</span>
                    </div>
                    <div class="action-btn" data-page-target="all-users-page">
                        <i class="material-icons">people_alt</i>
                        <span>All Users Info</span>
                    </div>
                    <div class="action-btn" data-page-target="post-updates-page">
                        <i class="material-icons">campaign</i>
                        <span>Post Updates</span>
                    </div>
                    <div class="action-btn" data-page-target="tournament-results-page">
                        <i class="material-icons">leaderboard</i>
                        <span>Post Results</span>
                    </div>
                </div>
            </div>

            <!-- TASK MANAGEMENT PAGE (NEW: To list, add, and delete tasks) -->
            <div class="page page-content hidden" id="task-management-page" style="padding: 16px;">
                <h1 style="color: var(--primary-color); margin-top: 0;">Task Management</h1>
                
                <div class="material-card list-item" onclick="navigateTo('add-task-page')" style="background-color: #e0f7fa; margin-bottom: 24px; cursor: pointer;">
                    <strong>+ Add New Task</strong>
                    <i class="material-icons" style="color: var(--primary-color);">add_circle</i>
                </div>
                
                <h3 style="margin-top: 0;">Current Tasks (Delete Option)</h3>
                <div id="current-task-list">
                    <p>Loading tasks...</p>
                </div>
            </div>

            <!-- ADD TASK PAGE (Destination of the "Add New" button) -->
            <div class="page page-content hidden" id="add-task-page" style="padding: 16px;">
                <h1 style="color: var(--primary-color); margin-top: 0;">Add New Task</h1>
                <div class="material-card material-form">
                    <label for="task-name">Task Name</label>
                    <input type="text" id="task-name" placeholder="e.g., Complete Daily Survey">
                    
                    <label for="task-reward">Reward (Coins)</label>
                    <input type="number" id="task-reward" placeholder="e.g., 50">
                    
                    <label for="task-link">Task Link/URL</label>
                    <input type="text" id="task-link" placeholder="e.g., https://example.com/task">
                    
                    <label for="task-steps">Steps to Complete</label>
                    <input type="text" id="task-steps" placeholder="e.g., 5 steps (Short description)">

                    <label for="task-remark">Internal Remark (Optional)</label>
                    <textarea id="task-remark" rows="3" placeholder="Notes for this task..."></textarea>
                    
                    <button class="material-btn" onclick="addTask()">Add Task</button>
                </div>
            </div>
            
            <!-- TOURNAMENT MANAGEMENT PAGE (NEW: To list and edit tournaments) -->
            <div class="page page-content hidden" id="tournament-management-page" style="padding: 16px;">
                <h1 style="color: var(--primary-color); margin-top: 0;">Tournament Management</h1>
                
                <div class="material-card list-item" onclick="navigateTo('add-tournament-page')" style="background-color: #e0f7fa; margin-bottom: 24px; cursor: pointer;">
                    <strong>+ Add New Tournament</strong>
                    <i class="material-icons" style="color: var(--primary-color);">add_circle</i>
                </div>
                
                <h3 style="margin-top: 0;">Upcoming Tournaments (Edit Room/Details)</h3>
                <div id="tournament-edit-list">
                    <p>Loading tournaments...</p>
                </div>
            </div>

            <!-- ADD TOURNAMENT PAGE (Destination of the "Add New" button) -->
            <div class="page page-content hidden" id="add-tournament-page" style="padding: 16px;">
                <h1 style="color: var(--primary-color); margin-top: 0;">Add New Tournament</h1>
                <div class="material-card material-form">
                    <label for="tour-id">Tournament ID (Unique)</label>
                    <input type="text" id="tour-id" placeholder="e.g., BGMI-001">
                    
                    <label for="tour-title">Title</label>
                    <input type="text" id="tour-title" placeholder="e.g., Weekly BGMI Squads">
                    
                    <label for="tour-datetime">Date/Time (Local)</label>
                    <input type="datetime-local" id="tour-datetime">
                    
                    <label for="tour-prize">Prize Pool (Coins)</label>
                    <input type="number" id="tour-prize" placeholder="e.g., 5000">
                    
                    <label for="tour-per-kill">Reward Per Kill (Coins)</label>
                    <input type="number" id="tour-per-kill" placeholder="e.g., 10">

                    <label for="tour-entry-fee">Entry Fee (Coins)</label>
                    <input type="number" id="tour-entry-fee" placeholder="e.g., 50">
                    
                    <label for="tour-mode">Mode (Solo/Duo/Squad)</label>
                    <select id="tour-mode">
                        <option value="Solo">Solo</option>
                        <option value="Duo">Duo</option>
                        <option value="Squad">Squad</option>
                    </select>

                    <button class="material-btn" onclick="addTournament()">Add Tournament</button>
                </div>
            </div>
            
            <!-- EDIT TOURNAMENT MODAL (Hidden by default) -->
            <div class="modal-overlay hidden" id="edit-tournament-modal">
                <div class="modal-content" style="text-align: left;">
                    <h3>Edit Tournament: <span id="modal-edit-tour-title"></span></h3>
                    <div class="material-form">
                        <label>Room ID</label>
                        <input type="text" id="edit-room-id" placeholder="Enter Room ID">
                        <label>Room Password</label>
                        <input type="text" id="edit-room-pass" placeholder="Enter Room Password">
                        <label>New Date/Time (Optional)</label>
                        <input type="datetime-local" id="edit-datetime">
                        <button class="material-btn" style="width: 100%;" onclick="saveEditedTournament()">Save Changes</button>
                        <button class="material-btn" style="width: 100%; background-color: #757575; margin-top: 8px;" onclick="closeModal('edit-tournament-modal')">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- TASK REQUESTS PAGE -->
            <div class="page page-content hidden" id="task-requests-page" style="padding: 16px;">
                <h1 style="color: var(--primary-color); margin-top: 0;">Task Submission Requests</h1>
                <div id="task-requests-list">
                    <p>No pending task requests.</p>
                </div>
            </div>
            
            <!-- Rework/Reject Modal -->
            <div class="modal-overlay hidden" id="task-action-modal">
                <div class="modal-content" style="text-align: left;">
                    <h3 id="modal-action-title"></h3>
                    <p>User: <strong id="modal-action-username"></strong> | Task: <strong id="modal-action-taskname"></strong></p>
                    <label for="action-reason">Reason/Instructions:</label>
                    <textarea id="action-reason" rows="3" placeholder="Enter reason for rejection or instructions for rework..."></textarea>
                    
                    <button class="material-btn" style="width: 100%;" id="modal-action-confirm-btn" onclick="confirmTaskAction()"></button>
                    <button class="material-btn" style="width: 100%; background-color: #757575; margin-top: 8px;" onclick="closeModal('task-action-modal')">Cancel</button>
                </div>
            </div>


            <!-- WITHDRAWAL REQUESTS PAGE (Same as before) -->
            <div class="page page-content hidden" id="withdrawal-requests-page" style="padding: 16px;">
                <h1 style="color: var(--primary-color); margin-top: 0;">Withdrawal Requests</h1>
                <div id="withdrawal-requests-list">
                    <p>No pending withdrawal requests.</p>
                </div>
            </div>

            <!-- ALL USERS INFO PAGE -->
            <div class="page page-content hidden" id="all-users-page" style="padding: 16px;">
                <h1 style="color: var(--primary-color); margin-top: 0;">All Users Management</h1>
                <input type="text" id="user-search" placeholder="Search by Username/Email" style="width: 100%; padding: 10px; margin-bottom: 16px; border-radius: 4px;">
                <div id="users-list">
                    <p>Loading users...</p>
                </div>

                <!-- User Details Modal (for Update Balance/Block) -->
                <div class="modal-overlay hidden" id="user-details-modal">
                    <div class="material-card" style="width: 85%; max-width: 350px; text-align: left;">
                        <h3 id="modal-username" style="margin-top: 0; color: var(--primary-color);"></h3>
                        <p>Email: <span id="modal-email"></span></p>
                        <p>Current Coins: <strong id="modal-coins"></strong></p>
                        <p>Total Earned: <span id="modal-total-earned"></span></p>
                        <p>Tasks/Tournaments: <span id="modal-user-stats"></span></p>
                        <p>Status: <strong id="modal-status"></strong></p>

                        <h4 style="margin-top: 20px;">Update Balance</h4>
                        <input type="number" id="balance-amount" placeholder="Amount to Add (+)/Subtract (-)">
                        <textarea id="balance-reason" rows="2" placeholder="Reason for change (required for user transaction history)"></textarea>
                        <button class="material-btn" style="width: 100%; margin-top: 8px;" onclick="updateUserBalance()">Save Balance</button>

                        <button class="material-btn danger-btn" style="width: 100%; margin-top: 16px;" id="block-unblock-btn" onclick="toggleBlockUser()">Block/Unblock User</button>
                        <button class="material-btn" style="width: 100%; background-color: #757575; margin-top: 8px;" onclick="closeModal('user-details-modal')">Close</button>
                    </div>
                </div>
            </div>

            <!-- POST UPDATES PAGE (Same as before) -->
            <div class="page page-content hidden" id="post-updates-page" style="padding: 16px;">
                <h1 style="color: var(--primary-color); margin-top: 0;">Post App Update</h1>
                <div class="material-card material-form">
                    <label for="update-content">Update Content</label>
                    <textarea id="update-content" rows="6" placeholder="Type your app update announcement here..."></textarea>
                    
                    <button class="material-btn" onclick="postUpdate()">Post Update to Users</button>
                </div>
            </div>

            <!-- ADD TOURNAMENT RESULTS PAGE (Results Payout) -->
            <div class="page page-content hidden" id="tournament-results-page" style="padding: 16px;">
                <h1 style="color: var(--primary-color); margin-top: 0;">Post Tournament Results</h1>
                <div class="material-card material-form">
                    <label for="select-tournament">Select Tournament</label>
                    <select id="select-tournament" style="margin-bottom: 20px;">
                        <option value="">-- Select Tournament --</option>
                    </select>

                    <h3 style="margin-bottom: 10px;">Top 3 Winners (Username)</h3>
                    <!-- Rank 1 -->
                    <label>Rank 1 (Username)</label>
                    <input type="text" id="rank1-username" placeholder="User's Username">
                    <label>Rank 1 Reward (Coins)</label>
                    <input type="number" id="rank1-reward" placeholder="Coins">

                    <!-- Rank 2 -->
                    <label style="margin-top: 10px;">Rank 2 (Username)</label>
                    <input type="text" id="rank2-username" placeholder="User's Username">
                    <label>Rank 2 Reward (Coins)</label>
                    <input type="number" id="rank2-reward" placeholder="Coins">

                    <!-- Rank 3 -->
                    <label style="margin-top: 10px;">Rank 3 (Username)</label>
                    <input type="text" id="rank3-username" placeholder="User's Username">
                    <label>Rank 3 Reward (Coins)</label>
                    <input type="number" id="rank3-reward" placeholder="Coins">
                    
                    <button class="material-btn" onclick="addTournamentResults()">Post Results & Payout</button>
                </div>
            </div>
            
        </div>
        
        <!-- Back to Home Button -->
        <div class="back-to-home">
            <button class="material-btn" style="width: 100%; background-color: #757575;" onclick="handleAdminLogout()">Logout</button>
        </div>

    </div>
</div>

<!-- CRITICAL FIX: Load Firebase using traditional <script> tags for max compatibility -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
    // --- FIREBASE INITIALIZATION ---

    const firebaseConfig = {
        apiKey: "AIzaSyDk6xgLmdFFD1dujl8N0_Aas_pLZhCD4no",
        authDomain: "earnerxdpro.firebaseapp.com",
        databaseURL: "https://earnerxdpro-default-rtdb.firebaseio.com",
        projectId: "earnerxdpro",
        storageBucket: "earnerxdpro.firebasestorage.app",
        messagingSenderId: "809985381581",
        appId: "1:809985381581:web:08745305d018aec46f4584",
        measurementId: "G-QRTG23N6HQ"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const auth = app.auth();
    const db = app.database();
    
    // --- UTILITY/GLOBAL SETUP ---

    let currentAdminUID = null; 
    let allUsersData = {}; 
    let allTasksData = {}; 
    let allTournamentsData = {};
    let activeUserForModal = null;
    let activeTaskRequestId = null;
    let activeTaskAction = null; 

    const ADMIN_EMAIL = "heml92304@gmail.com";
    const ADMIN_PASS = "Admin12345"; 

    // --- Core Functions Exposed Globally ---

    window.navigateTo = function(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
        document.getElementById(pageId).classList.remove('hidden');

        const titleMap = {
            'admin-dashboard-page': 'Admin Dashboard',
            'add-task-page': 'Add New Task',
            'task-management-page': 'Task Management',
            'add-tournament-page': 'Add New Tournament',
            'task-requests-page': 'Task Requests',
            'withdrawal-requests-page': 'Withdrawals',
            'all-users-page': 'All Users Info',
            'post-updates-page': 'Post Updates',
            'tournament-results-page': 'Post Results',
            'tournament-management-page': 'Edit Tournaments'
        };

        document.getElementById('app-bar-title').textContent = titleMap[pageId] || 'Admin Panel';
        if (pageId !== 'admin-dashboard-page') {
            document.getElementById('back-btn').classList.remove('hidden');
        } else {
            document.getElementById('back-btn').classList.add('hidden');
        }

        if (pageId === 'admin-dashboard-page') listenToDashboardData();
        if (pageId === 'task-requests-page') loadTaskRequests();
        if (pageId === 'withdrawal-requests-page') loadWithdrawalRequests();
        if (pageId === 'all-users-page') loadAllUsers();
        if (pageId === 'tournament-results-page') loadTournamentSelect();
        if (pageId === 'task-management-page') renderCurrentTasks(); // New function call
        if (pageId === 'tournament-management-page') renderTournamentEditList(); // New function call
    }
    
    window.openModal = function(modalId) { document.getElementById(modalId).classList.remove('hidden'); }
    window.closeModal = function(modalId) { document.getElementById(modalId).classList.add('hidden'); }

    // CRITICAL: Guaranteed Login function using V8 SDK
    window.handleAdminLogin = async function() {
        const email = document.getElementById('admin-email').value;
        const password = document.getElementById('admin-password').value;
        const errorElement = document.getElementById('admin-login-error');
        errorElement.classList.add('hidden');

        if (email !== ADMIN_EMAIL || password !== ADMIN_PASS) {
             errorElement.textContent = "Invalid Admin Credentials (Client Check).";
             errorElement.classList.remove('hidden');
             return;
        }

        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            errorElement.textContent = "Firebase Login Failed: " + error.message;
            errorElement.classList.remove('hidden');
        }
    }

    window.handleAdminLogout = async function() {
        try {
            await auth.signOut();
            document.getElementById('admin-email').value = '';
            document.getElementById('admin-password').value = '';
        } catch (error) {
            console.error("Logout Error:", error);
        }
    }

    // Auth State Listener (Critical for UI switch)
    auth.onAuthStateChanged((user) => {
        if (user && user.email === ADMIN_EMAIL) {
            currentAdminUID = user.uid;
            document.getElementById('admin-auth-page').classList.add('hidden');
            document.getElementById('admin-app').classList.remove('hidden');
            navigateTo('admin-dashboard-page');
            
            listenToDashboardData();
            listenToTasks();
            listenToTournaments();

        } else {
            currentAdminUID = null;
            document.getElementById('admin-auth-page').classList.remove('hidden');
            document.getElementById('admin-app').classList.add('hidden');
        }
    });

    // *** FIX: Ensure navigation listeners are set ONLY after the DOM is fully interactive ***
    function initializeNavigation() {
        document.querySelectorAll('[data-page-target]').forEach(el => {
            el.removeEventListener('click', handleNavClick);
            el.addEventListener('click', handleNavClick);
        });
    }

    function handleNavClick(e) {
        const targetId = e.currentTarget.getAttribute('data-page-target');
        if(targetId) window.navigateTo(targetId);
    }
    
    document.addEventListener('DOMContentLoaded', initializeNavigation);

    // --- DASHBOARD & CRUD LOGIC (All functions below are complete and correct) ---
    
    function listenToDashboardData() {
         db.ref('users').on('value', (snapshot) => {
            const users = snapshot.val() || {};
            allUsersData = users;
            let count = 0;
            let totalRewards = 0;

            for (const uid in users) {
                 if (users[uid].email) {
                    count++;
                    totalRewards += users[uid].totalEarned || 0;
                 }
            }

            document.getElementById('total-users-count').textContent = count;
            document.getElementById('total-rewards-given').textContent = totalRewards.toLocaleString();
        });
    }

    function listenToTasks() {
        db.ref('tasks').on('value', (snapshot) => {
            allTasksData = snapshot.val() || {};
            document.getElementById('total-tasks-added').textContent = Object.keys(allTasksData).length;
        });
    }

    function listenToTournaments() {
        db.ref('tournaments').on('value', (snapshot) => {
            allTournamentsData = snapshot.val() || {};
            document.getElementById('total-tournaments-added').textContent = Object.keys(allTournamentsData).length;
        });
    }

    // NEW: Renders list of all current tasks with delete button
    function renderCurrentTasks() {
        const container = document.getElementById('current-task-list');
        let html = '';
        const tasks = Object.entries(allTasksData);

        if (tasks.length === 0) {
            container.innerHTML = '<p>No tasks currently added.</p>';
            return;
        }

        tasks.forEach(([id, task]) => {
            html += `
                <div class="material-card list-item">
                    <div>
                        <strong>${task.name}</strong>
                        <p style="font-size: 0.8rem; margin: 4px 0;">Reward: ${task.reward} C | Steps: ${task.steps}</p>
                    </div>
                    <div class="list-item-controls">
                        <button class="material-btn danger-btn" style="padding: 6px 12px; font-size: 0.8rem;" onclick="deleteTask('${id}', '${task.name}')">Delete</button>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }
    
    // NEW: Delete Task Logic
    window.deleteTask = async function(taskId, taskName) {
        if (!confirm(`Are you sure you want to PERMANENTLY delete the task: ${taskName}? This cannot be undone.`)) return;

        try {
            // Delete the task
            await db.ref('tasks/' + taskId).remove();
            
            // NOTE: Task requests/completions are kept for history, but are orphaned.
            
            alert(`Task "${taskName}" deleted successfully!`);
            // List will automatically refresh due to listener
        } catch (error) {
            alert("Failed to delete task: " + error.message);
        }
    }

    window.addTask = async function() {
        const name = document.getElementById('task-name').value;
        const reward = parseInt(document.getElementById('task-reward').value);
        const link = document.getElementById('task-link').value;
        const steps = document.getElementById('task-steps').value;
        const remark = document.getElementById('task-remark').value;

        if (!name || isNaN(reward) || reward <= 0 || !link || !steps) {
            alert("Please fill in all required fields.");
            return;
        }

        try {
            await db.ref('tasks').push().set({ name, reward, link, steps, remark, createdAt: firebase.database.ServerValue.TIMESTAMP });

            alert("Task Added Successfully!");
            document.getElementById('task-name').value = document.getElementById('task-reward').value = document.getElementById('task-link').value = document.getElementById('task-steps').value = document.getElementById('task-remark').value = '';
            navigateTo('task-management-page'); // Navigate to new list view
        } catch (error) {
            alert("Failed to add task: " + error.message);
        }
    }

    // --- TOURNAMENT MANAGEMENT FUNCTIONS ---

    // Renders the list of upcoming tournaments with an edit button
    function renderTournamentEditList() {
        const container = document.getElementById('tournament-edit-list');
        let html = '';
        // Filter for tournaments that are upcoming AND do not have results posted
        const upcomingTours = Object.entries(allTournamentsData).filter(([id, tour]) => 
            tour.dateTime && tour.dateTime > Date.now() && !tour.results
        );

        if (upcomingTours.length === 0) {
            container.innerHTML = '<p>No upcoming tournaments to edit.</p>';
            return;
        }

        upcomingTours.forEach(([id, tour]) => {
            // Count joined players (or default to 0)
            const joinedCount = Object.keys(tour.joinedUsers || {}).length;

            html += `
                <div class="material-card list-item" style="align-items: flex-start;">
                    <div style="flex-grow: 1;">
                        <strong>${tour.title}</strong>
                        <p style="font-size: 0.8rem; margin: 4px 0;">Entry: ${tour.entryFee} C | Date: ${new Date(tour.dateTime).toLocaleDateString()}</p>
                        <p style="font-size: 0.8rem; color: #00796B;">Joined Players: ${joinedCount} <a href="#" onclick="viewJoinedPlayers(event, '${id}', '${tour.title}')">View Details</a></p>
                        <p style="font-size: 0.8rem; color: ${tour.roomId ? 'green' : 'orange'};">Room Details: ${tour.roomId ? 'SET' : 'MISSING'}</p>
                    </div>
                    <div class="list-item-controls">
                        <button class="material-btn" style="padding: 6px 12px; font-size: 0.8rem;" onclick="openEditTournamentModal('${id}')">Edit Room/Time</button>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }
    
    // NEW: View Joined Players Details
    window.viewJoinedPlayers = function(e, tourId, tourName) {
        e.preventDefault();
        const tour = allTournamentsData[tourId];
        const joinedUsers = tour.joinedUsers || {};
        
        let listHtml = `<h3>Joined Players for: ${tourName}</h3>`;
        if (Object.keys(joinedUsers).length === 0) {
             listHtml += `<p>No players have joined this tournament yet.</p>`;
        } else {
             listHtml += `<ul style="list-style-type: none; padding: 0; text-align: left;">`;
             for (const userId in joinedUsers) {
                 const user = joinedUsers[userId];
                 listHtml += `<li><strong>${user.username}</strong> (IGN: ${user.ign}, UID: ${user.gameUID})</li>`;
             }
             listHtml += `</ul>`;
        }
        
        // Use the generic modal to display the list
        document.getElementById('modal-action-title').innerHTML = listHtml;
        document.getElementById('action-reason').value = '';
        document.getElementById('action-reason').classList.add('hidden');
        document.getElementById('modal-action-confirm-btn').classList.add('hidden');
        document.getElementById('modal-action-confirm-btn').textContent = 'Close'; // Use button for Close action
        document.getElementById('modal-action-confirm-btn').style.backgroundColor = '#757575';
        
        // Re-open/hijack the task-action-modal for display only
        openModal('task-action-modal');
        document.querySelector('#task-action-modal .modal-content').style.maxWidth = '400px';
        document.querySelector('#task-action-modal .modal-content').style.textAlign = 'left';
        document.querySelector('#task-action-modal .material-btn[onclick="closeModal(\'task-action-modal\')"]').textContent = 'Close';

        // NOTE: A more robust approach would be a dedicated Tournament View Modal
    }


    window.addTournament = async function() {
        const id = document.getElementById('tour-id').value.trim();
        const title = document.getElementById('tour-title').value.trim();
        const dateTime = document.getElementById('tour-datetime').value;
        const prizePool = parseInt(document.getElementById('tour-prize').value);
        const perKill = parseInt(document.getElementById('tour-per-kill').value);
        const entryFee = parseInt(document.getElementById('tour-entry-fee').value);
        const mode = document.getElementById('tour-mode').value;


        if (!id || !title || !dateTime || isNaN(prizePool) || isNaN(perKill) || isNaN(entryFee)) {
            alert("Please fill in all required fields with valid values.");
            return;
        }
        if ((await db.ref('tournaments/' + id).once('value')).exists()) {
             alert(`Tournament ID '${id}' already exists.`);
             return;
        }

        try {
            await db.ref('tournaments/' + id).set({
                id, title, mode,
                dateTime: new Date(dateTime).getTime(),
                prizePool, perKill, entryFee,
                joinedUsers: {}, results: null,
                roomId: '',
                roomPass: '',
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });

            alert("Tournament Added Successfully!");
            document.getElementById('tour-id').value = document.getElementById('tour-title').value = document.getElementById('tour-datetime').value = document.getElementById('tour-prize').value = document.getElementById('tour-per-kill').value = document.getElementById('tour-entry-fee').value = '';
            navigateTo('tournament-management-page'); 
        } catch (error) {
            alert("Failed to add tournament: " + error.message);
        }
    }

    window.openEditTournamentModal = function(tourId) {
        const tour = allTournamentsData[tourId];
        if (!tour) return alert("Tournament data not found.");

        document.getElementById('modal-edit-tour-title').textContent = tour.title;
        document.getElementById('edit-room-id').value = tour.roomId || '';
        document.getElementById('edit-room-pass').value = tour.roomPass || '';
        document.getElementById('edit-datetime').value = tour.dateTime ? new Date(tour.dateTime).toISOString().substring(0, 16) : '';
        document.getElementById('edit-tournament-modal').dataset.tourId = tourId;

        openModal('edit-tournament-modal');
    }

    window.saveEditedTournament = async function() {
        const tourId = document.getElementById('edit-tournament-modal').dataset.tourId;
        const roomId = document.getElementById('edit-room-id').value.trim();
        const roomPass = document.getElementById('edit-room-pass').value.trim();
        const newDateTimeString = document.getElementById('edit-datetime').value;

        try {
            const updates = {
                roomId: roomId,
                roomPass: roomPass,
            };
            if (newDateTimeString) {
                updates.dateTime = new Date(newDateTimeString).getTime();
            }

            await db.ref(`tournaments/${tourId}`).update(updates);
            closeModal('edit-tournament-modal');
            alert("Tournament details updated successfully!");
        } catch (error) {
            alert("Failed to save changes: " + error.message);
        }
    }
    
    // --- TASK REQUESTS ---

    function loadTaskRequests() {
        db.ref('taskRequests').orderByChild('status').equalTo('Pending').on('value', (snapshot) => {
            const requests = [];
            snapshot.forEach(child => requests.push({ id: child.key, ...child.val() }));
            renderTaskRequests(requests);
        });
    }

    function renderTaskRequests(requests) {
        const container = document.getElementById('task-requests-list');
        if (requests.length === 0) {
            container.innerHTML = '<p>No pending task requests.</p>';
            return;
        }

        const html = requests.map(req => `
            <div class="material-card" style="border-left: 5px solid var(--primary-color);">
                <strong>${req.taskName}</strong> for <strong>${req.username}</strong>
                <p style="margin: 4px 0;">Reward: <strong>${req.reward} Coins</strong> | Status: **Pending**</p>
                <p style="margin: 4px 0; color: #00796B;">User Submission: <span style="font-style: italic;">${req.ssLink}</span></p>
                <div style="margin-top: 10px; display: flex; gap: 8px;">
                    <button class="material-btn" onclick="approveTask('${req.id}', '${req.userId}', '${req.taskId}', ${req.reward}, '${req.taskName}')">Approve</button>
                    <button class="material-btn" style="background-color: orange;" onclick="prepareTaskAction('${req.id}', '${req.userId}', '${req.taskId}', '${req.username}', '${req.taskName}', 'Rework')">Rework</button>
                    <button class="material-btn danger-btn" onclick="prepareTaskAction('${req.id}', '${req.userId}', '${req.taskId}', '${req.username}', '${req.taskName}', 'Reject')">Reject</button>
                </div>
            </div>
        `).join('');
        container.innerHTML = html;
    }
    
    window.prepareTaskAction = function(reqId, userId, taskId, username, taskName, action) {
        activeTaskRequestId = reqId;
        activeTaskAction = { userId, taskId, username, taskName, action };

        document.getElementById('modal-action-title').textContent = `${action} Submission`;
        document.getElementById('modal-action-username').textContent = username;
        document.getElementById('modal-action-taskname').textContent = taskName;
        document.getElementById('modal-action-confirm-btn').textContent = `Confirm ${action}`;
        document.getElementById('action-reason').value = '';

        document.querySelector('#task-action-modal .modal-content').style.maxWidth = '350px';
        document.querySelector('#task-action-modal .modal-content').style.textAlign = 'center';
        document.getElementById('action-reason').classList.remove('hidden');
        document.getElementById('modal-action-confirm-btn').classList.remove('hidden');


        if (action === 'Rework') {
            document.getElementById('action-reason').placeholder = 'Enter instructions for the user (required)...';
            document.getElementById('modal-action-confirm-btn').style.backgroundColor = 'orange';
        } else {
            document.getElementById('action-reason').placeholder = 'Enter reason for rejection (required)...';
            document.getElementById('modal-action-confirm-btn').style.backgroundColor = 'var(--secondary-color)';
        }

        openModal('task-action-modal');
    }
    
    window.confirmTaskAction = async function() {
        const reason = document.getElementById('action-reason').value.trim();
        if (!reason) {
            alert("Please enter a reason or instructions.");
            return;
        }

        const { userId, taskId, action } = activeTaskAction;

        try {
            await db.ref('taskRequests/' + activeTaskRequestId).update({ 
                status: action, 
                [action.toLowerCase() + 'By']: currentAdminUID,
                [action.toLowerCase() + 'Time']: Date.now(),
                reason: reason
            });

            if (action === 'Rework') {
                 await db.ref('users/' + userId + '/tasksPending').update({
                    [taskId]: { status: 'Rework', reworkReason: reason, timestamp: Date.now(), taskName: activeTaskAction.taskName }
                 });
            } else if (action === 'Reject') {
                 await db.ref('users/' + userId + '/tasksCompleted').update({
                    [taskId]: { status: 'Rejected', reason: reason, timestamp: Date.now(), taskName: activeTaskAction.taskName }
                 });
                 await db.ref('users/' + userId + '/tasksPending').child(taskId).remove();
            }

            alert(`Task marked as ${action} successfully!`);
            closeModal('task-action-modal');
            activeTaskRequestId = null;
            activeTaskAction = null;
        } catch (error) {
            alert(`Failed to complete action: ${error.message}`);
        }
    }

    window.approveTask = async function(reqId, userId, taskId, reward, taskName) {
        if (!confirm(`Confirm approval for ${taskName} to reward ${reward} Coins?`)) return;

        try {
            const userRef = db.ref('users/' + userId);
            const userData = (await userRef.once('value')).val();
            if (!userData) throw new Error("User not found.");

            const newCoins = (userData.coins || 0) + reward;
            const newTotalEarned = (userData.totalEarned || 0) + reward;

            await userRef.update({
                coins: newCoins,
                totalEarned: newTotalEarned,
                [`tasksCompleted/${taskId}`]: { taskName: taskName, reward: reward, status: 'Completed', timestamp: Date.now() },
                [`tasksPending/${taskId}`]: null
            });

            await db.ref('users/' + userId + '/transactions').push().set({ type: 'Credit', amount: reward, reason: `Task Reward: ${taskName}`, status: 'Completed', timestamp: Date.now() });

            await db.ref('taskRequests/' + reqId).update({ status: 'Approved', approvedBy: currentAdminUID, approvalTime: Date.now() });

            alert("Task Approved and Coins Credited!");
        } catch (error) {
            alert("Approval Failed: " + error.message);
        }
    }

    // --- WITHDRAWAL REQUESTS (Logic unchanged) ---
    function loadWithdrawalRequests() {
        db.ref('withdrawalRequests').orderByChild('status').equalTo('Pending').on('value', (snapshot) => {
            const requests = [];
            snapshot.forEach(child => requests.push({ id: child.key, ...child.val() }));
            renderWithdrawalRequests(requests);
        });
    }

    function renderWithdrawalRequests(requests) {
        const container = document.getElementById('withdrawal-requests-list');
        if (requests.length === 0) {
            container.innerHTML = '<p>No pending withdrawal requests.</p>';
            return;
        }

        const html = requests.map(req => `
            <div class="material-card" style="border-left: 5px solid var(--secondary-color);">
                <strong>${req.amount} Coins</strong> to ${req.username}
                <p style="margin: 4px 0;">Method: <strong>${req.method}</strong></p>
                <p style="margin: 4px 0;">Details: <strong style="color: var(--secondary-color);">${req.details}</strong></p>
                <p style="font-size: 0.8rem; color: #757575;">Requested: ${new Date(req.timestamp || 0).toLocaleDateString()}</p>
                <div style="margin-top: 10px; display: flex; gap: 8px;">
                    <button class="material-btn" style="flex-grow: 1;" onclick="approveWithdrawal('${req.id}', '${req.userId}', '${req.transactionKey}')">Mark Paid</button>
                    <button class="material-btn danger-btn" style="flex-grow: 1;" onclick="rejectWithdrawal('${req.id}', '${req.userId}', ${req.amount}, '${req.transactionKey}')">Refund & Reject</button>
                </div>
            </div>
        `).join('');
        container.innerHTML = html;
    }
    
    window.approveWithdrawal = async function(reqId, userId, txKey) {
        if (!confirm(`Confirm payment? Coins are ALREADY deducted from user's balance.`)) return;
        
        try {
            await db.ref('withdrawalRequests/' + reqId).update({ status: 'Completed', completionTime: Date.now() });
            await db.ref(`users/${userId}/transactions/${txKey}`).update({ status: 'Paid' });
            alert("Withdrawal marked as Paid (Completed).");
        } catch (error) {
            alert("Approval Failed: " + error.message);
        }
    }

    window.rejectWithdrawal = async function(reqId, userId, amount, txKey) {
        if (!confirm(`Confirm rejection and refund of ${amount} Coins to the user?`)) return;
        
        try {
            const userRef = db.ref('users/' + userId);
            const userData = (await userRef.once('value')).val();
            const currentCoins = userData.coins || 0;
            const newCoins = currentCoins + amount;

            await userRef.update({ coins: newCoins });
            await db.ref('users/' + userId + '/transactions').push().set({ type: 'Credit', amount: amount, reason: 'Withdrawal Request Refunded (Rejected)', status: 'Completed', timestamp: Date.now() });
            
            await db.ref(`users/${userId}/transactions/${txKey}`).update({ status: 'Refunded/Rejected' });
            await db.ref('withdrawalRequests/' + reqId).update({ status: 'Rejected', rejectionTime: Date.now() });

            alert("Withdrawal Rejected and Coins Refunded.");
        } catch (error) {
            alert("Rejection Failed: " + error.message);
        }
    }

    // --- USER MANAGEMENT ---
    function loadAllUsers() {
        db.ref('users').on('value', (snapshot) => {
            allUsersData = snapshot.val() || {};
            renderUsersList(allUsersData);
        });
        document.getElementById('user-search').addEventListener('input', filterUsers);
    }
    
    function filterUsers(e) {
        const searchTerm = e.target.value.toLowerCase();
        const filteredUsers = {};
        for (const uid in allUsersData) {
            const user = allUsersData[uid];
            if (user.username && user.email && (user.username.toLowerCase().includes(searchTerm) || user.email.toLowerCase().includes(searchTerm))) {
                filteredUsers[uid] = user;
            }
        }
        renderUsersList(filteredUsers);
    }

    function renderUsersList(users) {
        const container = document.getElementById('users-list');
        const userKeys = Object.keys(users);

        if (userKeys.length === 0) {
            container.innerHTML = '<p>No users found.</p>';
            return;
        }

        const html = userKeys.map(uid => {
            const user = users[uid];
            // CRITICAL FIX: Explicitly exclude the admin from the user list
            if (user.email === ADMIN_EMAIL || !user.email) return '';
            
            const statusColor = user.isBlocked ? 'var(--secondary-color)' : 'var(--primary-color)';
            return `
                <div class="material-card list-item" onclick="viewUserDetails('${uid}')">
                    <strong>${user.username || 'N/A'}</strong> (${user.email})
                    <p style="margin: 4px 0; font-size: 0.9rem;">Coins: ${user.coins || 0} | Status: ${user.isBlocked ? 'BLOCKED' : 'Active'}</p>
                </div>
            `;
        }).join('');
        container.innerHTML = html || '<p>No registered users found (excluding admin).</p>';
    }

    window.viewUserDetails = function(uid) {
        const user = allUsersData[uid];
        if (!user) return alert("User data not found.");
        
        const taskCount = Object.keys(user.tasksCompleted || {}).filter(key => user.tasksCompleted[key].status === 'Completed').length;
        const tournamentCount = Object.keys(user.joinedTournaments || {}).length;

        activeUserForModal = uid;
        document.getElementById('modal-username').textContent = user.username;
        document.getElementById('modal-email').textContent = user.email;
        document.getElementById('modal-coins').textContent = user.coins;
        document.getElementById('modal-total-earned').textContent = user.totalEarned;
        document.getElementById('modal-user-stats').textContent = `Tasks: ${taskCount}, Tournaments: ${tournamentCount}`;
        document.getElementById('modal-status').textContent = user.isBlocked ? 'BLOCKED' : 'Active';
        document.getElementById('block-unblock-btn').textContent = user.isBlocked ? 'Unblock User' : 'Block User';
        document.getElementById('block-unblock-btn').classList.toggle('danger-btn', !user.isBlocked);

        document.getElementById('balance-amount').value = '';
        document.getElementById('balance-reason').value = '';

        openModal('user-details-modal');
    }

    window.updateUserBalance = async function() {
        const uid = activeUserForModal;
        const amount = parseInt(document.getElementById('balance-amount').value);
        const reason = document.getElementById('balance-reason').value.trim();

        if (isNaN(amount) || amount === 0 || !reason) {
            alert("Please enter a valid amount (positive or negative) and a reason.");
            return;
        }

        try {
            const userRef = db.ref('users/' + uid);
            const currentCoins = (await userRef.once('value')).val().coins || 0;
            const newCoins = currentCoins + amount;

            await userRef.update({ coins: newCoins });

            await db.ref('users/' + uid + '/transactions').push().set({
                type: amount > 0 ? 'Credit' : 'Debit',
                amount: Math.abs(amount),
                reason: `Admin Adjustment: ${reason}`,
                status: 'Completed',
                adminUid: currentAdminUID,
                timestamp: Date.now()
            });

            alert(`Balance updated for ${allUsersData[uid].username}. New Balance: ${newCoins} Coins.`);
            closeModal('user-details-modal');
        } catch (error) {
            alert("Balance update failed: " + error.message);
        }
    }

    window.toggleBlockUser = async function() {
        const uid = activeUserForModal;
        const user = allUsersData[uid];
        const newBlockStatus = !user.isBlocked;
        const action = newBlockStatus ? 'Block' : 'Unblock';

        if (!confirm(`Are you sure you want to ${action} ${user.username}? ${newBlockStatus ? 'Blocking will also prevent their login in the user app.' : ''}`)) return;

        try {
            await db.ref('users/' + uid).update({ isBlocked: newBlockStatus });
            
            alert(`${user.username} ${action}ed successfully.`);
            closeModal('user-details-modal');
        } catch (error) {
            alert(`${action} failed: ` + error.message);
        }
    }


    window.postUpdate = async function() {
        const content = document.getElementById('update-content').value.trim();

        if (!content) {
            alert("Update content cannot be empty.");
            return;
        }

        try {
            await db.ref('updates').push().set({
                content: content,
                postedBy: currentAdminUID,
                timestamp: Date.now()
            });

            alert("Update Posted to User App Successfully!");
            document.getElementById('update-content').value = '';
            navigateTo('admin-dashboard-page');
        } catch (error) {
            alert("Failed to post update: " + error.message);
        }
    }


    function loadTournamentSelect() {
        // Post Results Page: Populate the Select dropdown
        const select = document.getElementById('select-tournament');
        select.innerHTML = '<option value="">-- Select Tournament --</option>';

        for (const id in allTournamentsData) {
            const tour = allTournamentsData[id];

            if (!tour.results && tour.dateTime && tour.dateTime < Date.now()) { 
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `${tour.title} (${new Date(tour.dateTime).toLocaleDateString()})`;
                select.appendChild(option);
            }
        }
        if (select.options.length === 1) {
            select.innerHTML = '<option value="">-- No finished tournaments to post results for --</option>';
        }
    }

    window.addTournamentResults = async function() {
        const tourId = document.getElementById('select-tournament').value;
        if (!tourId) return alert("Please select a tournament.");

        const winners = [
            { rank: 1, username: document.getElementById('rank1-username').value.trim(), reward: parseInt(document.getElementById('rank1-reward').value) },
            { rank: 2, username: document.getElementById('rank2-username').value.trim(), reward: parseInt(document.getElementById('rank2-reward').value) },
            { rank: 3, username: document.getElementById('rank3-username').value.trim(), reward: parseInt(document.getElementById('rank3-reward').value) }
        ];

        const validWinnersInput = winners.filter(w => w.username && w.reward >= 0 && !isNaN(w.reward));
        if (validWinnersInput.length === 0) {
            return alert("No valid winner entries found.");
        }

        const validWinners = [];
        for (const winner of validWinnersInput) {
            const matchingUserEntry = Object.entries(allUsersData).find(([uid, user]) => user.username && user.username.toLowerCase() === winner.username.toLowerCase());
            if (matchingUserEntry) {
                validWinners.push({ rank: winner.rank, username: matchingUserEntry[1].username, reward: winner.reward, userId: matchingUserEntry[0] });
            }
        }

        if (validWinners.length === 0) {
            return alert("No valid, registered usernames found among the entered winners.");
        }

        if (!confirm(`Confirm posting results for ${allTournamentsData[tourId].title} and making payouts to ${validWinners.length} winner(s)?`)) return;

        try {
            for (const winner of validWinners) {
                const userRef = db.ref('users/' + winner.userId);
                const userData = (await userRef.once('value')).val();

                const newCoins = (userData.coins || 0) + winner.reward;
                const newTotalEarned = (userData.totalEarned || 0) + winner.reward;

                await userRef.update({ coins: newCoins, totalEarned: newTotalEarned });

                await db.ref('users/' + winner.userId + '/transactions').push().set({ type: 'Credit', amount: winner.reward, reason: `Tournament Reward: ${allTournamentsData[tourId].title} (Rank ${winner.rank})`, status: 'Completed', timestamp: Date.now() });
            }

            await db.ref('tournaments/' + tourId).update({ results: validWinners, resultsPosted: Date.now() });

            alert(`Tournament results posted and ${validWinners.length} payouts completed!`);
            
            document.getElementById('select-tournament').value = '';
            document.getElementById('rank1-username').value = document.getElementById('rank1-reward').value = '';
            document.getElementById('rank2-username').value = document.getElementById('rank2-reward').value = '';
            document.getElementById('rank3-username').value = document.getElementById('rank3-reward').value = '';
            navigateTo('admin-dashboard-page');

        } catch (error) {
            alert("Posting results and payout failed: " + error.message);
        }
    }
</script>
</body>
                        </html>
